name: Build JAR and Deploy to EC2 (via ECR)

on:
  push:
    branches: [ "master" ]   # dev로 바꾸고 싶으면 여기만 수정
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write   # OIDC 토큰 사용 허용
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Build jar with Gradle
        run: |
          chmod +x gradlew
          ./gradlew bootJar -x test
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          cp "$JAR_FILE" app.jar

      # === 여기서부터 AWS IAM Role + ECR 로그인 ===
      - name: Configure AWS credentials (OIDC + IAM Role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::143692367933:role/GithubActionsBuskMateRole
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: buskmate    # ECR 리포 이름
          IMAGE_TAG: latest           # 또는 ${{ github.sha }}
        run: |
          echo "Registry: $ECR_REGISTRY"
          echo "Repository: $ECR_REPOSITORY"
          echo "Tag: $IMAGE_TAG"

          # app.jar를 Docker 컨텍스트에 두고, Dockerfile 사용
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # === 이제 EC2에 가서 pull + run만 ===
      - name: Deploy on EC2 (pull from ECR and run)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ECR 로그인 (EC2 쪽에서도)
            aws --version || sudo yum install -y awscli

            REGION=ap-northeast-2
            ECR_REGISTRY=${{ steps.ecr-login.outputs.registry }}
            ECR_REPOSITORY=buskmate
            IMAGE_TAG=latest

            aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            docker stop buskmate-app || true
            docker rm buskmate-app || true

            docker run -d -p 8080:8080 --name buskmate-app \
              $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
