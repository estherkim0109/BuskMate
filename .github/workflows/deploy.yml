name: Build JAR and Deploy to EC2 (jar 기반 배포)

on:
  push:
    branches: [ "master" ]   # master에 push 될 때마다 실행
  workflow_dispatch:         # 필요할 때 수동 실행도 가능

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. JDK 21 세팅
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # 3. Gradle로 JAR 빌드
      - name: Build jar with Gradle
        run: |
          chmod +x gradlew
          ./gradlew bootJar -x test

      # 4. 결과 JAR 파일 이름을 app.jar로 통일
      - name: Prepare artifact (rename jar)
        run: |
          ls build/libs
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          echo "Using JAR file: $JAR_FILE"
          cp "$JAR_FILE" app.jar

      # 5. EC2로 app.jar + Dockerfile 복사 (코드 전체 X, 실행파일 + 설정만)
      - name: Copy jar and Dockerfile to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: |
            app.jar
            Dockerfile
          target: /home/ec2-user/buskmate-deploy

      # 6. EC2에서 Docker build + 컨테이너 재시작
      - name: Deploy on EC2 (Docker build & run)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /home/ec2-user/buskmate-deploy

            echo "현재 디렉토리 내용:"
            ls

            echo "Docker 이미지 빌드"
            docker build -t buskmate .

            echo "기존 컨테이너 정리"
            docker stop buskmate-app || true
            docker rm buskmate-app || true

            echo "새 컨테이너 실행"
            docker run -d -p 8080:8080 --name buskmate-app buskmate

            echo "실행 중 컨테이너 확인"
            docker ps
