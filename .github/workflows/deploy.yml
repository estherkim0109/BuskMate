name: Build JAR and Deploy to EC2 (jar 기반 배포)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Build jar with Gradle
        run: |
          chmod +x gradlew
          ./gradlew bootJar -x test
          echo "=== build/libs 내용 ==="
          ls -l build/libs
          # 만들어진 jar 중 첫 번째를 app.jar 로 복사
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          cp "$JAR_FILE" app.jar
          echo "=== app.jar 확인 ==="
          ls -l app.jar

      - name: Copy jar and Dockerfile to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # 방금 만든 app.jar + Dockerfile 두 개만 전송
          source: "app.jar,Dockerfile"
          target: "~/buskmate-deploy"
          overwrite: true

      - name: Deploy on EC2 (Docker build & run)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/buskmate-deploy
            docker build -t buskmate .
            docker stop buskmate-app || true
            docker rm buskmate-app || true
            docker run -d -p 8080:8080 --name buskmate-app buskmate
